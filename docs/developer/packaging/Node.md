# Node.js Package Packaging Guide

This document explains how to add npm/Node.js packages to the nix-registry.

## When to Use

Use Node.js packages when:

- Adding npm packages as CLI tools
- The package is available on the npm registry
- You need Node.js-based command-line utilities

## File Structure

Node.js packages are located in `node/22/` directory:

```
node/22/
  composition.nix      # Composition setup (generated by node2nix)
  node-env.nix         # Node environment utilities (generated by node2nix)
  node-packages.nix    # Generated package definitions (generated by node2nix)
  node-packages.json   # Source package list (manually edited)
  export.nix           # Export configuration with custom overrides
```

## Files Overview

### node-packages.json

The source file listing all npm packages to be packaged. This is the only file you typically edit manually.

```json
[
  "@upstash/cli",
  "action-docs",
  "typescript-json-schema",
  "swagger-typescript-api",
  "@kirinnee/semantic-generator",
  "openapi-to-postmanv2"
]
```

### composition.nix

Generated by node2nix. Defines the composition that imports the node environment and packages:

```nix
{ pkgs ? import <nixpkgs> { inherit system; }
, system ? builtins.currentSystem
, nodejs ? pkgs."nodejs_14"
}:

let
  nodeEnv = import ./node-env.nix {
    inherit (pkgs) stdenv lib python2 runCommand writeTextFile writeShellScript;
    inherit pkgs nodejs;
    libtool = if pkgs.stdenv.isDarwin then pkgs.cctools or pkgs.darwin.cctools else null;
  };
in
import ./node-packages.nix {
  inherit (pkgs) fetchurl nix-gitignore stdenv lib fetchgit;
  inherit nodeEnv;
}
```

### node-packages.nix

Generated by node2nix. Contains all package definitions with their dependencies, sources, and build instructions. This file can be very large (thousands of lines) as it includes all transitive dependencies.

### export.nix

The export configuration that exposes packages with optional custom overrides:

```nix
{ trivialBuilders, nixpkgs, nodejs }:
let
  n = import ./composition.nix { pkgs = nixpkgs; inherit nodejs; };
in
with n;
(rec {
  sg_raw = n."@kirinnee/semantic-generator".override {
    buildInputs = [
      nixpkgs.nodePackages.npm
    ];
    nativeBuildInputs = [ nixpkgs.pkg-config ];
  };
  sg = trivialBuilders.writeShellScriptBin {
    name = "sg";
    version = sg_raw.version;
    text = ''
      export PATH="${nodejs}/bin:$PATH"
      ${sg_raw}/bin/sg "$@"
    '';
  };
  upstash = n."@upstash/cli";
  action_docs = n."action-docs";
  typescript_json_schema = n."typescript-json-schema";
  swagger_typescript_api = n."swagger-typescript-api";
  openapi_to_postmanv2 = n."openapi-to-postmanv2";
})
```

## Adding a New Package

### Step 1: Add to node-packages.json

Add the npm package name to `node/22/node-packages.json`:

```json
[
  "@upstash/cli",
  "action-docs",
  "your-new-package" // Add your package here
]
```

### Step 2: Generate Nix Files

Run the node2nix generation command:

```bash
pls gen:node:22
```

This command runs:

```bash
node2nix -i ./node/22/node-packages.json \
         -e ./node/22/node-env.nix \
         -o ./node/22/node-packages.nix \
         -c ./node/22/composition.nix
```

### Step 3: Add to export.nix (if needed)

Most packages work without modification. Add to `export.nix` only if:

- You want to rename the package (e.g., `@kirinnee/semantic-generator` to `sg`)
- You need native dependencies
- You need a wrapper script

Simple case (no modifications needed):

```nix
your_new_package = n."your-new-package";
```

### Step 4: Import in default.nix

The `default.nix` already imports all packages from `node/22/export.nix`:

```nix
node22 = import ./node/22/export.nix {
  inherit trivialBuilders;
  nixpkgs = nixpkgs-2511;
  nodejs = nixpkgs-unstable.nodejs_22;
};
```

New packages in `export.nix` are automatically available.

### Step 5: Test the Build

```bash
nix build .#your_new_package
```

### Step 6: Add to CI Verification

Add the package to `.github/workflows/ci.yaml`:

1. Add `.#your_new_package` to the `nix shell` command
2. Add `your-new-package --version` to the verification commands

See [CI Verification](./CIVerification.md) for detailed instructions.

## Handling Native Dependencies

Some npm packages require native dependencies (C libraries, etc.). Use `buildInputs` and `nativeBuildInputs` to provide them.

### Example with Native Dependencies

```nix
sg_raw = n."@kirinnee/semantic-generator".override {
  buildInputs = [
    nixpkgs.nodePackages.npm
  ];
  nativeBuildInputs = [ nixpkgs.pkg-config ];
};
```

### Common Native Dependencies

| Dependency Type | Package           | Example Use       |
| --------------- | ----------------- | ----------------- |
| Build tools     | `pkg-config`      | Finding libraries |
| Python          | `python3`         | node-gyp builds   |
| C libraries     | `openssl`, `zlib` | Native bindings   |
| macOS tools     | `cctools`         | Darwin builds     |

### Wrapper Pattern for PATH

Some packages need Node.js in PATH at runtime:

```nix
sg = trivialBuilders.writeShellScriptBin {
  name = "sg";
  version = sg_raw.version;
  text = ''
    export PATH="${nodejs}/bin:$PATH"
    ${sg_raw}/bin/sg "$@"
  '';
};
```

## Package Naming Conventions

### Scoped Packages

Scoped npm packages (e.g., `@upstash/cli`) are accessed with quotes:

```nix
upstash = n."@upstash/cli";
```

### Custom Names

Create aliases in `export.nix`:

```nix
# Rename @kirinnee/semantic-generator to sg
sg = trivialBuilders.writeShellScriptBin { ... };
```

### Underscores in Nix

Use underscores instead of hyphens for attribute names:

```nix
# npm: action-docs -> nix: action_docs
action_docs = n."action-docs";

# npm: typescript-json-schema -> nix: typescript_json_schema
typescript_json_schema = n."typescript-json-schema";
```

## CI Integration

After adding a package, update CI verification in `.github/workflows/ci.yaml`:

```yaml
- name: Nix Build
  run: >-
    nix shell nixpkgs#bash
    .#your_new_package    # Add here
    ...
    -c bash -c '
    your-new-package --version &&    # Add here
    ...
    '
```

See [CI Verification](./CIVerification.md) for complete details.

## Troubleshooting

### Build Fails with Native Dependency Error

**Symptom**: Error about missing header files or libraries

**Solution**: Add required dependencies to `buildInputs`:

```nix
your_package = n."your-package".override {
  buildInputs = [ nixpkgs.openssl nixpkgs.zlib ];
  nativeBuildInputs = [ nixpkgs.pkg-config ];
};
```

### Package Not Found After Generation

**Symptom**: `nix build .#package` fails with attribute not found

**Solution**: Check that the package is exported in `export.nix`:

```nix
your_package = n."your-package";
```

### Version Mismatch

**Symptom**: Built version differs from expected

**Solution**: The version in `node-packages.json` is just the package name. node2nix fetches the latest version. To pin a version, specify it in `node-packages.json`:

```json
["package-name@1.2.3"]
```

### Darwin (macOS) Build Issues

**Symptom**: Build fails on macOS with linker errors

**Solution**: Ensure `libtool` is available in composition.nix (it should be by default).

## Upgrading Node Packages

To upgrade all Node packages to their latest versions:

1. Edit `node-packages.json` to update version pins (if any)
2. Run `pls gen:node:22` to regenerate
3. Test with `nix build .#package_name`
4. Commit with `update(minor): upgrade node packages`

## Related Documentation

- [CI Verification](./CIVerification.md) - Adding packages to CI
